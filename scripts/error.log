backend main î©± â¯ npx ts-node scripts/test-uniswap-v4.ts -n uni-sepolia -d weth-usdc -a 0.0005
[dotenv@17.2.4] injecting env (53) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
ðŸš€ Starting Uniswap V4 Provider Tests

Network (arg): uni-sepolia
Chain: Unichain Sepolia (1301)
Provider: UNISWAP_V4
Swap: 0.0005 WETH -> USDC
RPC: Alchemy (ALCHEMY_API_KEY set)


=== Wallet Balances ===
Wallet: 0xc073A5E091DC60021058346b10cD5A9b3F0619fE
Private key: loaded from WALLET_PRIVATE_KEY
[2026-02-06 15:46:54.936 +0530] INFO: Initializing swap providers...
[2026-02-06 15:46:54.936 +0530] INFO: Relay: No API key configured (optional - can build immediately without one)
[2026-02-06 15:46:54.936 +0530] WARN: 1inch API key not configured
[2026-02-06 15:46:54.936 +0530] INFO: Swap providers initialized
    providerCount: 5
[2026-02-06 15:46:54.938 +0530] INFO: Created fallback RPC provider
    chain: "UNICHAIN_SEPOLIA"
    rpcCount: 2
  WETH: 0.001000 (raw: 1000000000001000)
  USDC: 0.000000 (raw: 0)

=== Available Pools (V4 Quoter) ===
  Pair WETH/USDC (V4):
    WETH -> USDC fee tiers with liquidity: 0.05%, 0.3%
    USDC -> WETH fee tiers with liquidity: 0.05%

=== Testing Provider Initialization ===
âœ“ Provider initialized: UNISWAP_V4
âœ“ Supports Unichain Sepolia (1301): true

=== Testing Configuration Validation ===
âœ“ Configuration is valid

=== Testing Get Quote ===
Requesting quote for: {
  chain: 'UNICHAIN_SEPOLIA',
  from: 'WETH',
  to: 'USDC',
  amount: '0.0005 WETH',
  amountWei: '000500000000000000'
}
âœ“ Quote received:
  Amount In: 000500000000000000
  Amount Out: 931404
  Estimated Amount Out: 926746
  Gas Estimate: 48553
  Price Impact: 536823977.56
  Raw Quote: {
  "fee": 500,
  "tickSpacing": 10,
  "zeroForOne": false
}

=== Testing Build Transaction ===
âœ“ Transaction built:
  To: 0xf70536b3bcc1bd1a972dc186a2cf84cc6da6be5d
  Chain ID: 1301
  Gas Limit: 48553
  Data length: 2122 bytes
  Data (first 100 chars): 0x3593564c000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000...

=== Ensuring Permit2 + Universal Router Approval ===
  1. Approving WETH to Permit2 (max)...
     âœ“ Token approval to Permit2 confirmed
  2. Permit2.approve(WETH, Universal Router, amount, expiration)...
  âš  Approval failed: nonce has already been used (transaction="0x02f8ef82051503830f4240831e848082bab394000000000022d473030f116ddee9f6b43ac78ba380b88487517c450000000000000000000000004200000000000000000000000000000000000006000000000000000000000000f70536b3bcc1bd1a972dc186a2cf84cc6da6be5d0000000000000000000000000000000000000000000000000001c6bf52634000000000000000000000000000000000000000000000000000000000006985cdadc080a017e2317f20f8c5a5cf870d95ef456c3f63208d84ccf1978d91cfb850ae103a24a00e74b96b2fe066b46ae93c6ef56263df0e942ec41acef2389ca9b612c91eabeb", info={ "error": { "code": -32000, "message": "nonce too low: next nonce 4, tx nonce 3" } }, code=NONCE_EXPIRED, version=6.16.0)

=== Testing Transaction Simulation ===
âš  Simulation failed: missing revert data (action="estimateGas", data=null, reason=null, transaction={ "data": "0x3593564c000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000006985c0c800000000000000000000000000000000000000000000000000000000000000011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000320000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000003060c0f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000014000000000000000000000000031d0220469e10c4e71834a79b1f276d740d3768f000000000000000000000000420000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000001f4000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001c6bf5263400000000000000000000000000000000000000000000000000000000000000e241a00000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000042000000000000000000000000000000000000060000000000000000000000000000000000000000000000000001c6bf52634000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000031d0220469e10c4e71834a79b1f276d740d3768f00000000000000000000000000000000000000000000000000000000000e241a", "from": "0xc073A5E091DC60021058346b10cD5A9b3F0619fE", "to": "0xf70536B3bcC1bD1a972dc186A2cf84cC6da6Be5D" }, invocation=null, revert=null, code=CALL_EXCEPTION, version=6.16.0)

âœ… All tests completed!
[2026-02-06 15:47:03.418 +0530] ERROR: Uniswap V4 simulation failed
    error: {
      "code": "CALL_EXCEPTION",
      "action": "estimateGas",
      "data": null,
      "reason": null,
      "transaction": {
        "to": "0xf70536B3bcC1bD1a972dc186A2cf84cC6da6Be5D",
        "data": "0x3593564c000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000006985c0c800000000000000000000000000000000000000000000000000000000000000011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000320000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000003060c0f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000014000000000000000000000000031d0220469e10c4e71834a79b1f276d740d3768f000000000000000000000000420000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000001f4000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001c6bf5263400000000000000000000000000000000000000000000000000000000000000e241a00000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000042000000000000000000000000000000000000060000000000000000000000000000000000000000000000000001c6bf52634000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000031d0220469e10c4e71834a79b1f276d740d3768f00000000000000000000000000000000000000000000000000000000000e241a",
        "from": "0xc073A5E091DC60021058346b10cD5A9b3F0619fE"
      },
      "invocation": null,
      "revert": null,
      "shortMessage": "missing revert data",
      "info": {
        "error": {
          "code": 3,
          "message": "execution reverted"
        },
        "payload": {
          "method": "eth_estimateGas",
          "params": [
            {
              "value": "0x0",
              "from": "0xc073a5e091dc60021058346b10cd5a9b3f0619fe",
              "to": "0xf70536b3bcc1bd1a972dc186a2cf84cc6da6be5d",
              "data": "0x3593564c000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000006985c0c800000000000000000000000000000000000000000000000000000000000000011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000320000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000003060c0f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000014000000000000000000000000031d0220469e10c4e71834a79b1f276d740d3768f000000000000000000000000420000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000001f4000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001c6bf5263400000000000000000000000000000000000000000000000000000000000000e241a00000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000042000000000000000000000000000000000000060000000000000000000000000000000000000000000000000001c6bf52634000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000031d0220469e10c4e71834a79b1f276d740d3768f00000000000000000000000000000000000000000000000000000000000e241a"
            }
          ],
          "id": 43,
          "jsonrpc": "2.0"
        }
      }
    }
